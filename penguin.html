<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="osql.js"></script>
    <script>
        osql.requireLogin();
        var me;
        var roomID = osql.getParam('roomID');
        var count_turn = 0;

        $(document).ready(async function () {
            me = await osql.getMe();
            document.getElementById('firstname').innerHTML = me.fname + ' ' + me.lname;

            var sql = `select * from Rooms where roomID = '${roomID}';`;
            var objects = await osql.connect(sql);
            await makePenguin();
        });

        window.addEventListener('load', function () {
            showHints();
        });

        function buttonMakePressed() {
            location.href = "resultpenguin.html?roomID=" + roomID;
        }

        async function getPenguin() {
            if (blank_message() === "false") {
                window.alert("全ての項目を入力してください");
                return;
            }

            var coordinates = {
                x_rightleg: document.getElementById('x_rightleg').value,
                y_rightleg: document.getElementById('y_rightleg').value,
                x_leftleg: document.getElementById('x_leftleg').value,
                y_leftleg: document.getElementById('y_leftleg').value,
                x_rightarm: document.getElementById('x_rightarm').value,
                y_rightarm: document.getElementById('y_rightarm').value,
                x_leftarm: document.getElementById('x_leftarm').value,
                y_leftarm: document.getElementById('y_leftarm').value,
                x_righteye: document.getElementById('x_righteye').value,
                y_righteye: document.getElementById('y_righteye').value,
                x_lefteye: document.getElementById('x_lefteye').value,
                y_lefteye: document.getElementById('y_lefteye').value,
                x_mouth: document.getElementById('x_mouth').value,
                y_mouth: document.getElementById('y_mouth').value,
                x_body: document.getElementById('x_body').value,
                y_body: document.getElementById('y_body').value,
                x_face: document.getElementById('x_face').value,
                y_face: document.getElementById('y_face').value
            };

            var sql = `
                INSERT INTO Locations (x_rightleg, y_rightleg, x_leftleg, y_leftleg, x_rightarm, y_rightarm, x_leftarm, y_leftarm, x_righteye, y_righteye, x_lefteye, y_lefteye, x_mouth, y_mouth, x_body, y_body, x_face, y_face) 
                VALUES ('${coordinates.x_rightleg}', '${coordinates.y_rightleg}', '${coordinates.x_leftleg}', '${coordinates.y_leftleg}', '${coordinates.x_rightarm}', '${coordinates.y_rightarm}', '${coordinates.x_leftarm}', '${coordinates.y_leftarm}', '${coordinates.x_righteye}', '${coordinates.y_righteye}', '${coordinates.x_lefteye}', '${coordinates.y_lefteye}', '${coordinates.x_mouth}', '${coordinates.y_mouth}', '${coordinates.x_body}', '${coordinates.y_body}', '${coordinates.x_face}', '${coordinates.y_face}');
            `;
            await osql.connect(sql);
        }

        function blank_message() {
            var inputs = document.querySelectorAll('input[type="text"]');
            for (var input of inputs) {
                if (input.value.trim() === "") {
                    return "false";
                }
            }
            return "true";
        }

        async function showHints() {
            var sql = `select count(status) from Todos where roomID = '${roomID}' and status = TRUE;`;
            var status_objects = await osql.connect(sql);
            var count = Math.floor(parseInt(status_objects[0]['count(status)']) / 2);

            var sql2 = `select * from Hints;`;
            var hint_objects = await osql.connect(sql2);
            var html = '<table border="1">';
            for (var i = 0; i < count; i++) {
                var hint = hint_objects[i];
                html += `<tr><td>${hint.hintID}</td><td>${hint.hint}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('hints').innerHTML = html;
        }

        async function makePenguin() {
            count_turn++;
            var sql = `select * from Participation where roomID = '${roomID}' and userID='${me.id}';`;
            var orders_objects = await osql.connect(sql);
            var html = '';

            if (count_turn === orders_objects[0].orders) {
                if (count_turn === 1) {
                    html += `
                        <img src="image/leg.png" width="160" height="100" alt="サンプル画像"><br>
                        右足のx座標 <input type="text" id="x_rightleg">
                        右足のy座標 <input type="text" id="y_rightleg"><br>
                        <img src="image/leg.png" width="160" height="100" alt="サンプル画像"><br>
                        左足のx座標 <input type="text" id="x_leftleg">
                        左足のy座標 <input type="text" id="y_leftleg"><br>
                        <img src="image/rightarm.png" width="150" height="150" alt="サンプル画像"><br>
                        右腕のx座標 <input type="text" id="x_rightarm">
                        右腕のy座標 <input type="text" id="y_rightarm"><br>
                    `;
                } else if (count_turn === 2) {
                    html += `
                        <img src="image/leftarm.png" width="150" height="150" alt="サンプル画像"><br>
                        左腕のx座標 <input type="text" id="x_leftarm">
                        左腕のy座標 <input type="text" id="y_leftarm"><br>
                        <img src="image/eye.png" width="100" height="90" alt="サンプル画像"><br>
                        右目のx座標 <input type="text" id="x_righteye">
                        右目のy座標 <input type="text" id="y_righteye"><br>
                        <img src="image/eye.png" width="100" height="90" alt="サンプル画像"><br>
                        左目のx座標 <input type="text" id="x_lefteye">
                        左目のy座標 <input type="text" id="y_lefteye"><br>
                    `;
                } else if (count_turn === 3) {
                    html += `
                        <img src="image/mouth.png" width="200" height="200" alt="サンプル画像"><br>
                        口のx座標 <input type="text" id="x_mouth">
                        口のy座標 <input type="text" id="y_mouth"><br>
                        <img src="image/body.png" width="180" height="200" alt="サンプル画像"><br>
                        体のx座標 <input type="text" id="x_body">
                        体のy座標 <input type="text" id="y_body"><br>
                        <img src="image/face.png" width="200" height="125" alt="サンプル画像"><br>
                        顔のx座標 <input type="text" id="x_face">
                        顔のy座標 <input type="text" id="y_face"><br>
                    `;
                }
            } else {
                html = '他のメンバーが記入中です';
            }
            document.getElementById('pingus').innerHTML = html;
        }
    </script>
</head>

<body>
    <h1>ペンギンを作ろう</h1>
    <p>見本（サイズは適当）</p>
    <img src="image/pingu_sample.png" width="200" height="200" alt="サンプル画像"><br>
    <p>ゲットしたヒントを参考にしてペンギンを描こう！</p>
    <div id="hints"></div>
    <div id="pingus"></div>
    <button onclick="makePenguin()">次へ</button>
    <button onclick="buttonMakePressed()">作成</button>

</body>

</html>