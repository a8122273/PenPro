<!DOCTYPE html>

<html>


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="osql.js"></script>

    <script>
        //メモroomIDを表示しているが後でroomnameが表示されるようにしたい
        osql.requireLogin();
        $(document).ready(async function () {
            var me = await osql.getMe();
            console.log(me);
            var sql = `insert ignore into Users values('${me.userid}', '${me.fname}'+" "'${me.lname}');`;
            await osql.connect(sql);

            document.getElementById('firstname').innerHTML = me.fname + " " + me.lname;
            await showAllpingu();
        });

        function logout() {
            osql.logout();
        }

        async function showAllpingu() {
            var sql = `select * from Locations;`;
            var pingu_objects = await osql.connect(sql);
            var html = '';

            for (var i = 0; i < pingu_objects.length; i++) {
                var pingu_object = pingu_objects[i];
                var canvasID = 'pinguCanvas_' + pingu_object.roomID;
                html += pingu_object.roomID + '<br>';
                html += '<canvas id="' + canvasID + '" width="500" height="500" style="border: solid 1px;"></canvas>';
                html += '<br>';
                html = html + '<hr>';
            }
            document.getElementById('allpingu').innerHTML = html;
            for (var i = 0; i < pingu_objects.length; i++) {
                var pingu_object = pingu_objects[i];
                makePingu(pingu_object);
            }
        }
        function makePingu(pingu_object, canvasID) {
            var canvas = document.getElementById('pinguCanvas_' + pingu_object.roomID);
            var ctx = canvas.getContext('2d');

            // 背景を白く塗る
            ctx.clearRect(0, 0, 500, 500);

            // ピングーの体 
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_body, pingu_object.y_body, 90, 120, 0, 0, Math.PI * 2);
            ctx.fill();

            // ピングーの腹部
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_body, pingu_object.y_body, 70, 100, 0, 0, Math.PI * 2);
            ctx.fill();

            // ピングーの頭
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_face, pingu_object.y_face, 70, 55, 0, 0, Math.PI * 2);
            ctx.fill();

            // ピングーの足
            ctx.fillStyle = 'orange';
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_leftleg, pingu_object.y_leftleg, 45, 25, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_rightleg, pingu_object.y_rightleg, 45, 25, 0, 0, Math.PI * 2);
            ctx.fill();

            // ピングーの腕
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_leftarm, pingu_object.y_leftarm, 25, 90, Math.PI / 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_rightarm, pingu_object.y_rightarm, 25, 90, -Math.PI / 4, 0, Math.PI * 2);
            ctx.fill();

            // ピングーのくちばし
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.ellipse(pingu_object.x_mouth, pingu_object.y_mouth, 27, 13, 0, 0, Math.PI * 2);
            ctx.fill();

            // ピングーの目
            // 白目
            ctx.strokeStyle = 'black';
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(pingu_object.x_lefteye, pingu_object.y_lefteye, 15, 0, Math.PI * 2, true);
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(pingu_object.x_righteye, pingu_object.y_righteye, 15, 0, Math.PI * 2, true);
            ctx.fill();
            ctx.stroke();
            // 黒目
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(pingu_object.x_lefteye, pingu_object.y_lefteye, 10, 0, Math.PI * 2, true);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(pingu_object.x_righteye, pingu_object.y_righteye, 10, 0, Math.PI * 2, true);
            ctx.fill();
        }


    </script>

</head>

<body>
    <h1>みんなのペンギン</h1>
    <div style="text-align: right;">
        ようこそ <span id="firstname"></span>さん
        <a href="javascript:logout()">logout</a>
    </div>
    <hr>
    <div id="allpingu"></div>
</body>

</html>